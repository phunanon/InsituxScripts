
(function rand-near pos dist
  ;Needs higher Insitux version:
  ;(let angle (rand (* 2 (pi))))
  (let angle (/ 50 (rand-num 314)))
  (let xz [(cos angle) (sin angle)])
  ;(let point [(cos angle) 0 (sin angle)])
  ;Broken in Deadline:
  ;(let point (for * [dist] point))
  (let point [(* (0 xz) dist) 0 (* (1 xz) dist)])
  (map + point pos))

(function sent sender channel msg
;Needs higher Insitux version
; (when (starts-with? msg "(")
;   (dl.util.fmessage (eval msg)))

  (let parts (split msg))
  (let cmd (0 parts))
  (let body (join (sect parts)))
  (let body (if (!= body "") body))

  (when (= cmd "team")
    ((str "$dl.players." sender ".team")
     body)
    (dl.util.fmessage (str sender " team changed to " body)))

  (when (= cmd "kill")
    ((str "dl.players." body ".kill"))
    (dl.util.fmessage (str "Killed " body)))

  (when (= cmd "teleport")
    (let is-to (= (1 parts) "to"))
    (let a (if is-to (2 parts) sender))
    (let b (if is-to sender (1 parts)))
    ((str "$dl.players." a ".position")
     (position (str "dl.players." b)))
    (dl.util.fmessage (str "Teleported " a " to " b)))

  (when (= cmd "brrr")
    (let pos (position (str "dl.players." body)))
    (let i 0)
    (while (< i 100)
      (let i (inc i))
      (wait .01)
      (let rands [(rand-num 10) 0 (rand-num 10)])
      (dl.util.explosion (map + [(- (* i 2) 100) 0 0] rands pos)))
    (dl.util.fmessage (str "Brrr'd " body)))

  (when (= cmd "flare")
    (let who (or body sender))
    (let pos (position (str "dl.players." who)))
    (dl.util.explosion (map + [0 100 0] pos) "TestGrenade")
    (dl.util.fmessage (str "Fired flare above " who)))

  (when (= cmd "position")
    (let player (or body sender))
    (let pos (position (str "dl.players." player)))
    (dl.util.fmessage (str (round (0 pos)) ", " (round (2 pos)))))

  (when (= cmd "heal")
    (let player (or body sender))
    ((str "$dl.players." player ".health") 100)
    (dl.util.fmessage (str "Healed " player)))

  (when (= cmd "explode")
    (let is-near (= (1 parts) "near"))
    (let player ((if is-near 2 1) parts))
    (let pos (position (str "dl.players." player)))
    (let pos (if is-near (rand-near pos 48) pos))
    (dl.util.explosion pos "TestGrenade")
    (dl.util.fmessage (str "Exploded " body)))

  (chatbot-extra sender channel msg))

(function chatbot-extra sender channel msg null)
(dl.events.on_chat_message.kill)
(dl.util.fmessage "Loaded Insitux chatbot!
Note: where it says [player] replace with a player's name
    e.g. kill Player123
Commands:
  team security - switch to the Security team
  team insurgent - switch to the Insurgent team
  kill [player] - kill player
  heal - heal yourself fully
  heal [player] - heal a player fully
  brrr [player] - order airstrike on player
  flare - fire a flare above yourself
  flare [player] - fire a flare above a player
  explode [player] - kill player with an explosion
  explode near [player] - cause an explosion near the player
  position - write your position to the chat
  position [player] - write a player's position to the chat")
(dl.events.on_chat_message.connect sent)
